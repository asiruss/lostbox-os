<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="robots" content="noindex, nofollow">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Галерея</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background: #121212;
            color: white;
            padding: 10px;
             -webkit-tap-highlight-color: transparent;
        }
        .gallery-header {
            text-align: center;
            padding: 15px 0;
            font-size: 24px;
            font-weight: bold;
            border-bottom: 1px solid #333;
            margin-bottom: 15px;
        }
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 10px;
        }
        .gallery-item {
            position: relative;
            aspect-ratio: 3/4;
            border: 2px solid black;
            border-radius: 8px;
            overflow: hidden;
            background: #000;
            cursor: pointer;
        }
        .gallery-item img,
        .gallery-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .video-play-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 30px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .media-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .viewer-header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 15px 20px;
            display: flex;
            justify-content: flex-end;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, transparent 100%);
        }
        .download-btn, .delete-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(0,0,0,0.5);
            color: white;
            border: 1px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            margin-left: 10px;
        }
        .delete-btn {
            background: rgba(139, 0, 0, 0.7);
        }
        .viewer-content {
            max-width: 100%;
            max-height: 80vh;
            border: 2px solid white;
            border-radius: 5px;
        }
        .viewer-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 15px 0;
            text-align: center;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 100%);
            color: white;
            font-size: 14px;
        }
        .media-info {
            margin: 5px 0;
        }
        .close-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(0,0,0,0.5);
            color: white;
            border: 1px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            z-index: 1001;
        }
        .empty-gallery {
            text-align: center;
            padding: 50px 20px;
            color: #888;
            font-size: 18px;
        }
        .confirmation-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2c2c2c;
            padding: 20px;
            border-radius: 10px;
            z-index: 1002;
            text-align: center;
            display: none;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            border: 1px solid #444;
        }
        .confirmation-text {
            margin-bottom: 20px;
            font-size: 16px;
            line-height: 1.4;
        }
        .confirmation-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        .confirmation-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        .btn-yes {
            background: #d32f2f;
            color: white;
        }
        .btn-no {
            background: #2e7d32;
            color: white;
        }
    </style>
</head>
<body>
    <div class="gallery-header">Галерея</div>
    
    <div class="gallery-grid" id="galleryGrid">
        <!-- Контент будет добавлен динамически -->
    </div>
    
    <div class="empty-gallery" id="emptyGallery" style="display: none;">
        В галерее пока нет сохраненных фото и видео
    </div>

    <div class="media-viewer" id="mediaViewer">
        <div class="close-btn" id="closeViewer">←</div>
        <div class="viewer-header">
            <button class="download-btn" id="downloadBtn">↓</button>
            <button class="delete-btn" id="deleteBtn">✕</button>
        </div>
        <img id="viewerImage" class="viewer-content" style="display: none;" />
        <video id="viewerVideo" class="viewer-content" style="display: none;" controls></video>
        <div class="viewer-footer" id="viewerFooter">
            <!-- Информация о медиафайле будет добавлена здесь -->
        </div>
    </div>

    <div class="confirmation-dialog" id="confirmationDialog">
        <div class="confirmation-text">
            Вы точно хотите удалить этот файл?<br>
            Этот процесс необратим.
        </div>
        <div class="confirmation-buttons">
            <button class="confirmation-btn btn-yes" id="confirmYes">Да</button>
            <button class="confirmation-btn btn-no" id="confirmNo">Нет</button>
        </div>
    </div>

    <script>
        const DB_NAME = 'camera.user.storage';
        const DB_VERSION = 1;
        let db = null;
        let currentMedia = null;

        const galleryGrid = document.getElementById('galleryGrid');
        const emptyGallery = document.getElementById('emptyGallery');
        const mediaViewer = document.getElementById('mediaViewer');
        const viewerImage = document.getElementById('viewerImage');
        const viewerVideo = document.getElementById('viewerVideo');
        const closeViewer = document.getElementById('closeViewer');
        const downloadBtn = document.getElementById('downloadBtn');
        const deleteBtn = document.getElementById('deleteBtn');
        const viewerFooter = document.getElementById('viewerFooter');
        const confirmationDialog = document.getElementById('confirmationDialog');
        const confirmYes = document.getElementById('confirmYes');
        const confirmNo = document.getElementById('confirmNo');

        // Инициализация базы данных
        function initDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    const database = event.target.result;
                    if (!database.objectStoreNames.contains('media')) {
                        const store = database.createObjectStore('media', { keyPath: 'id', autoIncrement: true });
                        store.createIndex('type', 'type', { unique: false });
                        store.createIndex('timestamp', 'timestamp', { unique: false });
                    }
                };
            });
        }

        // Получение всех медиафайлов из базы данных
        async function getAllMedia() {
            if (!db) await initDatabase();
            
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['media'], 'readonly');
                const store = transaction.objectStore('media');
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Удаление медиафайла из базы данных
        async function deleteMedia(id) {
            if (!db) await initDatabase();
            
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['media'], 'readwrite');
                const store = transaction.objectStore('media');
                const request = store.delete(id);
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // Создание элемента миниатюры для галереи
        function createGalleryItem(media) {
            const item = document.createElement('div');
            item.className = 'gallery-item';
            item.dataset.id = media.id;
            
            // Используем blob напрямую
            if (media.type === 'photo') {
                const img = document.createElement('img');
                try {
                    img.src = URL.createObjectURL(media.blob);
                    item.appendChild(img);
                } catch (e) {
                    item.innerHTML = '<div style="color:white;text-align:center;padding:10px;">Ошибка фото</div>';
                }
            } 
            // Для видео
            else if (media.type === 'video') {
                const video = document.createElement('video');
                try {
                    video.src = URL.createObjectURL(media.blob);
                    video.muted = true;
                    
                    // Пытаемся получить первый кадр видео
                    video.addEventListener('loadeddata', function() {
                        if (video.readyState >= 2) {
                            try {
                                const canvas = document.createElement('canvas');
                                canvas.width = video.videoWidth;
                                canvas.height = video.videoHeight;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                                video.poster = canvas.toDataURL();
                            } catch (e) {
                                console.error('Ошибка создания превью:', e);
                            }
                        }
                    });
                    
                    item.appendChild(video);
                    
                    // Добавляем иконку воспроизведения
                    const playIcon = document.createElement('div');
                    playIcon.className = 'video-play-icon';
                    playIcon.innerHTML = '▶️';
                    item.appendChild(playIcon);
                } catch (e) {
                    item.innerHTML = '<div style="color:white;text-align:center;padding:10px;">Ошибка видео</div>';
                }
            }
            
            // Обработчик клика для просмотра медиа
            item.addEventListener('click', () => openMediaViewer(media));
            
            return item;
        }

        // Форматирование даты
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            
            return `${day}.${month}.${year} ${hours}:${minutes}`;
        }

        // Отображение информации о медиафайле
        function displayMediaInfo(media) {
            viewerFooter.innerHTML = '';
            
            const infoContainer = document.createElement('div');
            infoContainer.className = 'media-info';
            
            const dateInfo = document.createElement('div');
            dateInfo.textContent = `Создано: ${formatDate(media.timestamp)}`;
            
            const typeInfo = document.createElement('div');
            typeInfo.textContent = `Тип: ${media.type === 'photo' ? 'Фотография' : 'Видео'}`;
            
            infoContainer.appendChild(dateInfo);
            infoContainer.appendChild(typeInfo);
            
            viewerFooter.appendChild(infoContainer);
        }

        // Открытие медиа в полноэкранном режиме
        function openMediaViewer(media) {
            currentMedia = media;
            mediaViewer.style.display = 'flex';
            
            // Отображаем информацию о медиафайле
            displayMediaInfo(media);
            
            if (media.type === 'photo') {
                try {
                    viewerImage.src = URL.createObjectURL(media.blob);
                    viewerImage.style.display = 'block';
                    viewerVideo.style.display = 'none';
                } catch (e) {
                    alert('Ошибка открытия фото');
                    closeMediaViewer();
                }
            } else if (media.type === 'video') {
                try {
                    viewerVideo.src = URL.createObjectURL(media.blob);
                    viewerVideo.style.display = 'block';
                    viewerImage.style.display = 'none';
                } catch (e) {
                    alert('Ошибка открытия видео');
                    closeMediaViewer();
                }
            }
        }

        // Скачивание медиафайла
        function downloadMedia() {
            if (!currentMedia) return;
            
            try {
                const url = URL.createObjectURL(currentMedia.blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = currentMedia.filename || 
                            (currentMedia.type === 'photo' ? `photo_${currentMedia.id}.jpg` : `video_${currentMedia.id}.webm`);
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (e) {
                alert('Ошибка скачивания файла');
            }
        }

        // Показать диалог подтверждения удаления
        function showConfirmationDialog() {
            confirmationDialog.style.display = 'block';
        }

        // Скрыть диалог подтверждения удаления
        function hideConfirmationDialog() {
            confirmationDialog.style.display = 'none';
        }

        // Удаление медиафайла
        async function removeMedia() {
            if (!currentMedia) return;
            
            try {
                await deleteMedia(currentMedia.id);
                closeMediaViewer();
                await loadGallery(); // Перезагружаем галерею
            } catch (error) {
                console.error('Ошибка удаления медиафайла:', error);
                alert('Не удалось удалить медиафайл');
            }
        }

        // Закрытие просмотрщика
        function closeMediaViewer() {
            mediaViewer.style.display = 'none';
            viewerImage.style.display = 'none';
            viewerVideo.style.display = 'none';
            viewerVideo.pause();
            currentMedia = null;
            
            // Освобождаем URL объекты
            if (viewerImage.src) URL.revokeObjectURL(viewerImage.src);
            if (viewerVideo.src) URL.revokeObjectURL(viewerVideo.src);
            viewerImage.removeAttribute('src');
            viewerVideo.removeAttribute('src');
            
            // Очищаем информацию о медиафайле
            viewerFooter.innerHTML = '';
        }

        // Загрузка и отображение галереи
        async function loadGallery() {
            try {
                await initDatabase();
                const mediaItems = await getAllMedia();
                
                if (mediaItems.length === 0) {
                    emptyGallery.style.display = 'block';
                    return;
                }
                
                emptyGallery.style.display = 'none';
                
                // Сортируем по времени (новые сначала)
                mediaItems.sort((a, b) => b.timestamp - a.timestamp);
                
                // Очищаем сетку
                galleryGrid.innerHTML = '';
                
                // Добавляем элементы
                mediaItems.forEach(media => {
                    const item = createGalleryItem(media);
                    galleryGrid.appendChild(item);
                });
            } catch (error) {
                console.error('Ошибка загрузки галереи:', error);
                emptyGallery.textContent = 'Ошибка загрузки галереи';
                emptyGallery.style.display = 'block';
            }
        }

        // Обработчики событий
        closeViewer.addEventListener('click', closeMediaViewer);
        downloadBtn.addEventListener('click', downloadMedia);
        deleteBtn.addEventListener('click', () => showConfirmationDialog());
        
        confirmYes.addEventListener('click', async () => {
            hideConfirmationDialog();
            await removeMedia();
        });
        
        confirmNo.addEventListener('click', hideConfirmationDialog);

        // Загружаем галерею при открытии страницы
        window.addEventListener('load', loadGallery);
        
        // Закрытие по клику на затемненную область
        mediaViewer.addEventListener('click', (e) => {
            if (e.target === mediaViewer) {
                closeMediaViewer();
            }
        });
    </script>
</body>
</html>